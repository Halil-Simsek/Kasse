<!doctype html>
<html lang="de" data-theme="theme1">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Pottschatz - Kasse (V9.2 - Final Stable)</title>
<style>
/* --- VARIABLEN --- */
:root {
  /* Basis Schriftgr√∂√üen (DEFAULTS F√úR IPAD PRO 12.9") */
  --pbtn-emoji-size: 2.5vmin; 
  --pbtn-name-size: 2.5vmin;  
  --pbtn-emoji-size-px: 25px; 
  --pbtn-name-size-px: 15px;  
    
  --order-font-sm: 12px; 
  --order-font-md: 10px; 
  --order-font-lg: 12px; 

  /* Theme 1: Original (Dark - 8.19 Basis) */
  --bg-gradient-start: #2f353b;
  --bg-gradient-end: #373f43; /* Hintergrundfarbe f√ºr klebrige Elemente */
  --text-primary: #f0e5df;
  --text-muted: #f7f6eb;
  --panel-bg: rgba(255,255,255,0.05); /* Transparenter Panel-Hintergrund */
  --panel-bg-alt: rgba(255,255,255,0.10); 
  --btn-primary-bg: #ffae00;
  --btn-primary-text: #120a05;
  --btn-danger-bg: #b32428;
  --btn-danger-text: #f7f6eb;
  --btn-ghost-border: rgba(255,255,255,0.1);
  --btn-ghost-text: var(--text-primary);
  --divider-color: rgba(255,174,1); 
  --input-border: rgba(255,255,255,1);
  --modal-bg: #061022;
  --text-on-dark: #fff; 
  --text-on-light: #000; 
  --qty-bg-color: #000000; 
  --text-on-btn: var(--text-on-dark);
  --qty-text-color: var(--text-on-dark);
  --money-btn-bg: #444; 
  --pbtn-active-shadow: 0 0 10px 4px rgba(255, 255, 255, 0.6); 
  --splitter-color: var(--divider-color);
  --splitter-bg: rgba(255, 255, 255, 0.1);
  --pbtn-glass-border: rgba(255, 255, 255, 0.2); 
  --text-total-color: var(--divider-color); 
  --text-change-color: #44ff44; 
  --text-change-negative-color: #ff5555; 
}
/* --- FARBSCHEMATA (Unver√§ndert) --- */
[data-theme="theme2"] { --bg-gradient-start: #f1f5f9; --bg-gradient-end: #e2e8f0; --text-primary: #1e293b; --text-muted: #475569; --panel-bg: #ffffff; --panel-bg-alt: #f8fafc; --btn-primary-bg: #3b82f6; --btn-primary-text: #ffffff; --btn-danger-bg: #ef4444; --btn-danger-text: #ffffff; --btn-ghost-border: rgba(0,0,0,0.15); --btn-ghost-text: var(--text-primary); --divider-color: #3b82f6; --input-border: #3b82f6; --modal-bg: #f1f5f9; --text-on-btn: var(--text-on-light); --qty-text-color: var(--text-on-light); --qty-bg-color: #f7f7f7; --money-btn-bg: #bbb; --pbtn-active-shadow: 0 0 10px 4px rgba(0, 0, 0, 0.4); --splitter-bg: rgba(0, 0, 0, 0.1); --splitter-color: #3b82f6; --pbtn-glass-border: rgba(0, 0, 0, 0.1); --text-total-color: var(--divider-color); --text-change-color: #009900; --text-change-negative-color: #ef4444; }
[data-theme="theme3"] { --bg-gradient-start: #141309; --bg-gradient-end: #141309; --text-primary: #ffffff; --text-muted: #f4c00c; --panel-bg: rgba(255,255,255,0.05); --panel-bg-alt: rgba(255,255,255,0.08); --btn-primary-bg: #f4c00c; --btn-primary-text: #141309; --btn-danger-bg: #d93025; --btn-danger-text: #ffffff; --btn-ghost-border: rgba(255,255,255,0.2); --btn-ghost-text: var(--text-primary); --divider-color: #f4c00c; --input-border: #f4c00c; --modal-bg: #1f1e14; --text-on-btn: var(--text-on-dark); --qty-text-color: var(--text-on-dark); --money-btn-bg: #444; --pbtn-active-shadow: 0 0 10px 4px rgba(255, 255, 255, 0.6); --splitter-bg: rgba(255, 255, 255, 0.2); --splitter-color: #f4c00c; --pbtn-glass-border: rgba(255, 255, 255, 0.2); --text-total-color: var(--divider-color); --text-change-color: #44ff44; --text-change-negative-color: #ff5555; }
[data-theme="theme4"] { --bg-gradient-start: #222629; --bg-gradient-end: #222629; --text-primary: #ffffff; --text-muted: #86C232; --panel-bg: #474b4f; --panel-bg-alt: #3a3e41; --btn-primary-bg: #86C232; --btn-primary-text: #000000; --btn-danger-bg: #c62828; --btn-danger-text: #ffffff; --btn-ghost-border: rgba(255,255,255,0.2); --btn-ghost-text: var(--text-primary); --divider-color: #86C232; --input-border: #86C232; --modal-bg: #3a3e41; --text-on-btn: var(--text-on-dark); --qty-text-color: var(--text-on-dark); --money-btn-bg: #444; --pbtn-active-shadow: 0 0 10px 4px rgba(255, 255, 255, 0.6); --splitter-bg: rgba(255, 255, 255, 0.2); --splitter-color: #86C232; --pbtn-glass-border: rgba(255, 255, 255, 0.2); --text-total-color: var(--divider-color); --text-change-color: #86C232; --text-change-negative-color: #c62828; }
[data-theme="theme5"] { --bg-gradient-start: #fdfcf9; --bg-gradient-end: #fefbec; --text-primary: #44403c; --text-muted: #78716c; --panel-bg: #ffffff; --panel-bg-alt: #fefcfb; --btn-primary-bg: #c05621; --btn-primary-text: #ffffff; --btn-danger-bg: #d9534f; --btn-danger-text: #ffffff; --btn-ghost-border: rgba(0,0,0,0.1); --btn-ghost-text: var(--text-primary); --divider-color: #c05621; --input-border: #c05621; --modal-bg: #fdfcf9; --text-on-btn: var(--text-on-light); --qty-text-color: var(--text-on-light); --qty-bg-color: #f7f7f7; --money-btn-bg: #bbb; --pbtn-active-shadow: 0 0 10px 4px rgba(0, 0, 0, 0.4); --splitter-bg: rgba(0, 0, 0, 0.1); --splitter-color: #c05621; --pbtn-glass-border: rgba(0, 0, 0, 0.1); --text-total-color: #c05621; --text-change-color: #009900; --text-change-negative-color: #d9534f; }
[data-theme="theme6"] { --bg-gradient-start: #f0fdf4; --bg-gradient-end: #dcfce7; --text-primary: #14532d; --text-muted: #166534; --panel-bg: #ffffff; --panel-bg-alt: #fafffb; --btn-primary-bg: #22c55e; --btn-primary-text: #ffffff; --btn-danger-bg: #ef4444; --btn-danger-text: #ffffff; --btn-ghost-border: rgba(0,0,0,0.1); --btn-ghost-text: var(--text-primary); --divider-color: #22c55e; --input-border: #22c55e; --modal-bg: #f0fdf4; --text-on-btn: var(--text-on-light); --qty-text-color: var(--text-on-light); --qty-bg-color: #f7f7f7; --money-btn-bg: #bbb; --pbtn-active-shadow: 0 0 10px 4px rgba(0, 0, 0, 0.4); --splitter-bg: rgba(0, 0, 0, 0.1); --splitter-color: #22c55e; --pbtn-glass-border: rgba(0, 0, 0, 0.1); --text-total-color: #22c55e; --text-change-color: #166534; --text-change-negative-color: #ef4444; }


/* --- GRUND-LAYOUT --- */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);color:var(--text-primary); transition: background 0.3s, color 0.3s;overflow-x: hidden;}
.app{
    width: 100%;
    margin:0; 
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:16px;
    height: 100vh; 
}
#kasseView{
    flex-grow: 1; 
    display:flex; 
    gap:0; 
    min-height: 50px; 
} 
/* Splitter-Styling */
#resizer {
    width: 32px; 
    cursor: col-resize;
    position: relative;
    z-index: 10;
    transition: background-color 0.2s;
    flex-shrink: 0; 
    display: flex;
    justify-content: center;
    align-items: center;
}
#resizer:hover {
    background-color: var(--splitter-bg);
}
#resizer::before {
    content: '';
    display: block;
    width: 8px;
    height: 80%; 
    background-color: var(--splitter-color);
    border-radius: 6px;
    opacity: 0.8;
}

header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between}
h1{font-size:24px;margin:0} 
.small{color:var(--text-muted)}

/* --- PRODUKTE (Linke Spalte) --- */
.products{ 
    background:var(--panel-bg); 
    padding:14px; 
    border-radius:12px; 
    display:flex; 
    flex-direction:column; 
    gap:8px; 
    height: 100%; 
    min-height: 50px; 
    min-width: 50px; 
    flex-grow: 1; 
}
.products-header{display:flex;justify-content:space-between;align-items:center;gap:10px;}
.grid{ 
    flex:1; 
    overflow:auto; 
    display:grid; 
    grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); 
    grid-auto-rows: minmax(auto-fit, 1fr); 
    gap:6px; 
    padding-right: 6px; 
}

/* WICHTIG: Produktschalter Farben & Style (Glassmorphism) */
.pbtn {
  backdrop-filter: blur(8px); 
  -webkit-backdrop-filter: blur(8px); 
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); 
  background: var(--panel-bg-alt); 
  color: var(--text-primary);
  border: 1px solid var(--pbtn-glass-border); 
  border-radius:12px; 
  padding:20px 10px; 
  display: flex;
  flex-direction: column;
  justify-content: space-between; 
  height: 100%; 
  min-height: 60px;
  cursor: pointer;
  transition: all 0.1s ease;
}
/* NEU: Spezifische bunte Farben nur f√ºr Theme 1 (mit Transparenz f√ºr Glass-Effekt) */
[data-theme="theme1"] .pbtn {
    border-color: rgba(255,255,255,0.1); 
    color: var(--text-primary); 
}
/* Achtung: Farben sind nun leicht transparent (0.9), um den blur-Effekt zu erm√∂glichen! */
[data-theme="theme1"] .pbtn[data-id="p1"]{background:rgba(181, 45, 27, 0.9);color:#f7f6eb; border-color: rgba(255,255,255,0.3);} 
[data-theme="theme1"] .pbtn[data-id="p2"]{background:rgba(207, 204, 124, 0.9);color:#0a0a0a; border-color: rgba(0,0,0,0.3);} 
[data-theme="theme1"] .pbtn[data-id="p3"]{background:rgba(174, 232, 97, 0.9);color:#0a0a0a; border-color: rgba(0,0,0,0.3);} 
[data-theme="theme1"] .pbtn[data-id="p4"]{background:rgba(240, 223, 70, 0.9);color:#0a0a0a; border-color: rgba(0,0,0,0.3);} 
[data-theme="theme1"] .pbtn[data-id="p5"]{background:rgba(247, 246, 235, 0.9);color:#0a0a0a; border-color: rgba(0,0,0,0.3);} 
[data-theme="theme1"] .pbtn[data-id="p6"]{background:rgba(84, 54, 30, 0.9);color:#f0e5df; border-color: rgba(255,255,255,0.3);} 
[data-theme="theme1"] .pbtn[data-id="p7"]{background:rgba(179, 66, 66, 0.9);color:#f0e5df; border-color: rgba(255,255,255,0.3);} 
[data-theme="theme1"] .pbtn[data-id="p8"]{background:rgba(171, 52, 235, 0.9);color:#f0e5df; border-color: rgba(255,255,255,0.3);} 
[data-theme="theme1"] .pbtn[data-id="p9"]{background:rgba(28, 28, 28, 0.9);color:#d4652f; border-color: rgba(255,255,255,0.3);} 
[data-theme="theme1"] .pbtn[data-id="p10"]{background:rgba(28, 28, 28, 0.9);color:#8fbc8f; border-color: rgba(255,255,255,0.3);} 

/* Hover/Active States */
.pbtn:hover {
    filter: brightness(1.15);
}
.pbtn:active, .pbtn.active{ 
  background: var(--btn-primary-bg) !important; 
  color: var(--btn-primary-text) !important;
  box-shadow: var(--pbtn-active-shadow);
  border-color: var(--btn-primary-bg) !important;
}

.pbtn strong{
    font-weight: 700;
    display:flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    text-align: center;
    width: 100%;
} 
.pbtn-emoji { font-size: var(--pbtn-emoji-size); min-width: var(--pbtn-emoji-size-px); }
.pbtn-name { font-size: var(--pbtn-name-size); min-width: var(--pbtn-name-size-px); }
.pbtn span{font-size: var(--pbtn-name-size); transition: font-size 0.2s;} 


/* --- BESTELLUNG (Rechte Spalte) --- */
.order{ 
    background:var(--panel-bg); 
    padding:14px; 
    border-radius:12px; 
    display:flex; 
    flex-direction:column; 
    height: 100%; 
    min-height: 50px;
    min-width: 50px; 
    width: 100px; 
    gap:12px;
    flex-shrink: 0; 
}
.options{display:flex;flex-direction:column;gap:8px;align-items:flex-end;}
.options-header{font-weight:700;font-size: 14px;}
.options-buttons{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

/* Runder und gr√∂√üerer Farbw√§hler */
.color-switcher {
    display: flex;
    gap: 8px; 
    align-items: center;
    border-left: 1px solid var(--btn-ghost-border);
    padding-left: 12px;
}
.color-btn {
    width: 30px; 
    height: 30px; 
    border-radius: 50%; 
    border: 2px solid transparent; 
    cursor: pointer;
    transition: transform 0.2s, border-color 0.2s;
    padding: 0;
    flex-shrink: 0;
}
.color-btn.active {
    transform: scale(1.1);
    border-color: var(--btn-primary-bg); 
    box-shadow: 0 0 0 3px var(--bg-gradient-start); 
}

.order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0; gap:10px;}
.order-header .small { font-size: var(--order-font-sm); transition: font-size 0.2s; } 
.order-list{ flex:1; overflow:auto; padding-right:6px } 

/* Bestell-Items auf neue, gr√∂√üere Schriftgr√∂√üe anpassen */
.order-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px dashed var(--divider-color)}
.order-item strong { font-size: var(--order-font-md); transition: font-size 0.2s; }
.item-left{display:flex;gap:12px;align-items:center; flex-grow: 1;} 

/* NEU: Flex-Container f√ºr Quantity und Buttons, fixiert die Breite */
.item-controls { 
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0; 
    min-width: 100px; 
    justify-content: flex-end; 
}

/* HINWEIS: .qty min-width wurde zu width ge√§ndert f√ºr stabiles Layout */
.qty{background:var(--qty-bg-color);color: var(--qty-text-color);padding:8px 12px;border-radius:10px;width:65px;text-align:center; font-size: var(--order-font-md); transition: font-size 0.2s, background-color 0.3s, color 0.3s; flex-shrink: 0;}
.icon-btn{border: none;padding: 10px 12px;border-radius: 10px;cursor: pointer;font-weight: bold;color: var(--text-on-btn);transition: background-color 0.15s, color 0.3s;min-width: 36px;text-align: center; flex-shrink: 0;}
.order-item button[aria-label="minus"] { background: #CD0000; }
.order-item button[aria-label="plus"] { background: #228B22; }
.order-item button[aria-label="remove-item"] { background: transparent; color: var(--text-primary); border: 1px solid var(--btn-ghost-border); padding: 8px 10px; font-size: 18px; font-weight: normal; min-width: auto; }

/* =====================================================
--- SUMMARY/GELD ---
===================================================== */
.summary{ 
  padding:60px; 
  border-radius:12px; 
  background:linear-gradient(180deg, var(--panel-bg), var(--panel-bg-alt)); 
  margin-top:8px; 
  display: flex; 
  flex-direction: column; 
  gap: 16px; 
}

.summary .small { font-size: var(--order-font-sm); transition: font-size 0.2s; }
.summary .big { font-size: var(--order-font-lg); transition: font-size 0.2s; }

.row{
    display:flex;
    justify-content:space-between;
    align-items:center;
} 

/* NEU: Gesamtsumme (LINKSB√úNDIG) */
.summary-total-row {
    padding-bottom: 10px;
    border-bottom: 2px solid var(--btn-ghost-border); 
    justify-content: flex-start; 
    gap: 20px; 
}
.summary-total-row .small { 
    font-size: var(--order-font-md); 
    font-weight: 700;
}
.summary-total-row .big { 
    font-size: calc(var(--order-font-lg) * 1.3); 
    font-weight: 900;
    color: var(--text-total-color); 
}

/* NEU: 'Gegeben' und 'R√ºckgeld' nebeneinander */
.summary-input-row {
    display: flex;
    flex-direction: row;
    gap: 12px;
}
.input-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    flex: 1; 
}
.input-group.change-group {
    align-items: flex-start; 
}
.input-group .small { 
    font-size: var(--order-font-md); 
    font-weight: 700;
}
/* NEU: R√ºckgeld Anzeige-Box */
.input-group #changeDisplay {
    font-size: var(--order-font-lg); 
    font-weight: 900;
    color: var(--text-change-color); 
    padding: 12px; 
    border: 4px solid var(--btn-ghost-border); 
    border-radius: 10px;
    width: 100%;
    text-align: right; 
    min-height: 12px; 
}
/* NEU: R√ºckgeld-Anzeige bei Defizit (Rot) */
.input-group #changeDisplay.deficit {
    color: var(--text-change-negative-color) !important; 
    border-color: var(--text-change-negative-color);
}

.big{font-weight:700}

/* Input-Feld angepasst: Gr√∂√üere Schrift & LINKSB√úNDIGKEIT */
input[type=number], input[type=text]{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:4px solid var(--input-border);
  background:transparent;
  color:var(--text-primary);
  font-size:var(--order-font-lg); 
  font-weight: 700;
  text-align: left; 
}

/* Money-Grid: Abstand reduziert */
.money-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:0px}
/* Money-Button: Kompakte Ansicht */
.money-btn{
    padding:8px; 
    border-radius:80px;
    border:1.5px solid var(--divider-color);
    background:var(--money-btn-bg);
    color:#fff;
    font-weight:700;
    cursor:pointer;
    transition:0.15s all; 
    font-size: 32px; 
}
.money-btn:active{transform:scale(0.95);box-shadow:0 0 10px 3px #fff;}

/* Flex-Container f√ºr die beiden Zahlungs-Buttons */
.payment-buttons {
    display: flex;
    gap: 12px;
    margin-top: 0; 
    flex-direction: row; 
}
#saveOnlyBtn {
    flex-grow: 2; 
}
#saveAndPrintBtn {
    flex-grow: 1; 
    background: #444; 
    color: white;
}


/* --- GLOBALE BUTTONS --- */
.btn-primary{background:var(--btn-primary-bg);color:var(--btn-primary-text);border:1.5px solid var(--divider-color);padding:14px;border-radius:12px;font-weight:700;cursor:pointer;width:100%;font-size: 18px;}
.btn-ghost{background:transparent;border:1.5px solid var(--divider-color);padding:10px;border-radius:8px;color:var(--btn-ghost-text);cursor:pointer}
.btn-danger{background:var(--btn-danger-bg);color:var(--btn-danger-text);border:1.5px solid var(--divider-color);padding:14px;border-radius:12px;font-weight:700;width:100%;cursor:pointer;font-size: 18px;}

footer {
    grid-column: 1 / -1;
    text-align: center;
    padding: 8px 0;
    font-size: var(--order-font-sm);
    color: var(--text-muted);
}

/* --- LOG/MODAL STYLES (Unver√§ndert) --- */
#logView, #saveSuccessMessage {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 1000;
    display: none;
    background: rgba(0, 0, 0, 0.9);
    align-items: center;
    justify-content: center;
    padding: 20px;
}
#logView > div {
    background: var(--modal-bg);
    border-radius: 12px;
    padding: 20px;
    width: 80%;
    max-width: 600px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.modal-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
}
.modal-footer {
    display: flex;
    gap: 10px; 
}
.modal-footer button {
    flex: 1; 
}

#logList {
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 10px;
}
.log-item {
    border-bottom: 1px solid var(--btn-ghost-border);
    padding: 10px 0;
}
.log-item:last-child {
    border-bottom: none;
}
.log-row {
    display: flex;
    justify-content: space-between;
    margin-top: 4px;
    font-size: var(--order-font-sm);
}
.log-row.big {
    font-size: var(--order-font-md);
    font-weight: 700;
    color: var(--btn-primary-bg);
}
/* Styles f√ºr Success Message */
#saveSuccessMessage {
  position: fixed; top: 50%; left: 50%; 
  transform: translate(-50%, -50%);
  width: 20cm; 
  height: 15cm; 
  border-radius: 20px;
  background: linear-gradient(135deg, #FFC125 0%, #DAA520 100%); 
  color: #000000; 
  display: block; 
  flex-direction: column; justify-content: center; align-items: center;
  text-align: center; padding: 20px; 
  font-size: 16px; line-height: 1.2; font-weight: 700; z-index: 1000;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
  opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
}
#saveSuccessMessage.show {
  opacity: 1; visibility: visible; display: flex; 
}

/* WICHTIG: DRUCK-CSS */
@media print {
    .app > *:not(#saveSuccessMessage) { 
        display: none !important;
    }
    html, body {
        background: #fff !important; 
        color: #000 !important;
        margin: 0;
        padding: 0;
        overflow: hidden; 
    }
    #saveSuccessMessage {
        position: static !important;
        transform: none !important;
        width: 100% !important; 
        height: auto !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        padding: 10mm !important; 
        background: none !important; 
        color: #000 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        font-family: monospace; 
        font-size: 10pt;
    }
    .bon-header, .bon-footer { text-align: center; margin-bottom: 5mm; }
    .bon-item-row { display: flex; justify-content: space-between; line-height: 1.5; }
    .bon-separator { border-top: 1px dashed #000; margin: 5px 0; }
    .bon-total { font-weight: bold; font-size: 12pt; }
}


/* --- MEDIA QUERIES (FIXED: Hintergrund f√ºr Sticky-Element) --- */
@media (max-width:1100px){
¬† #kasseView{ 
    flex-direction: column; 
    gap: 16px;
    padding-bottom: 50px; 
  }
¬† .order{
    height:auto; 
    min-height: auto; 
    min-width: auto; 
    width: 100%;
    order: 1; 
    position: sticky; 
    top: 0; 
    z-index: 50; 
    box-shadow: 0 4px 8px rgba(0,0,0,0.4); 
    background: var(--bg-gradient-end); /* FIX: Sorgt f√ºr einen soliden Hintergrund, damit Produkte nicht durchscheinen! */
}
  .products { 
    height: auto; 
    min-width: auto;
    order: 2; 
  }
  #resizer { display: none; } 
¬† header{flex-direction: column; align-items: stretch; gap: 12px;}
¬† .options{align-items: stretch;}
¬† .options-buttons{justify-content: flex-start;}
  .products-header, .order-header { flex-wrap: wrap; }
  
  /* Im mobilen Modus "Gegeben" und "R√ºckgeld" untereinander */
  .summary-input-row {
      flex-direction: column;
  }
  .input-group.change-group {
      align-items: flex-start; 
  }
  .input-group #changeDisplay {
      text-align: left; 
  }
  
  /* Anpassung der Produktdichte f√ºr Telefone (iPhone) */
  .grid {
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
    grid-auto-rows: minmax(140px, 1fr); 
  }
}

/* --- ZUS√ÑTZLICHE OPTIMIERUNG F√úR KLEINERE TABLETS (z.B. 9.7 Zoll) --- */
.compact-ui {
  --pbtn-emoji-size: 3.5vmin; 
  --pbtn-name-size: 2.0vmin;  
  --pbtn-emoji-size-px: 35px; 
  --pbtn-name-size-px: 20px;  
    
  --order-font-sm: 14px; 
  --order-font-md: 17px; 
  --order-font-lg: 22px; 
}

/* Anpassung der Order-Panel Breite und Mindestbreite f√ºr 9.7" */
.compact-ui .order {
    min-width: 380px; 
    width: 420px; 
}
/* Erzwingt, dass die UI im Kompakt-Modus horizontal bleibt, auch wenn der Bildschirm schmaler ist */
@media (min-width: 840px) { 
    .compact-ui #kasseView { 
        flex-direction: row !important; 
        flex-wrap: nowrap !important; 
        gap: 0 !important; 
    }
    .compact-ui .products {
        min-width: 300px;
        flex-grow: 1;
    }
}
@media (max-width: 839px) { 
    .compact-ui #kasseView { 
        flex-direction: column !important;
    }
}
/* Resizer im Kompakt-Modus immer anzeigen, wenn horizontal */
.compact-ui #resizer {
    display: flex;
}
/* Versteckt den Resizer komplett unterhalb von 840px, da es dann vertikal ist */
@media (max-width: 839px) {
    #resizer {
        display: none !important;
    }
}
</style>
</head>
<body>
<div class="app" role="application">
<header>
  <div>
    <h1>Weihnachtsmarkt 2025 ‚Äî POTTSCHATZ</h1>
    <div class="small" id="statusRegion" aria-live="polite">AutoSave ‚Ä¢ Local CSV Export ‚Ä¢ Tool</div>
  </div>
  
  <div class="options">
    <div class="options-header">Optionen</div>
    <div class="options-buttons">
      <button class="btn-ghost" id="printBtn">Drucken (Kasse)</button>
      <button class="btn-ghost" id="showLogBtn">Erfassungen</button>
      <button class="btn-ghost" id="exportCsvBtn">Export CSV</button>
      <button class="btn-ghost" id="openExportFolderBtn">Zuletzt exportierte CSV √∂ffnen</button>
      
      <button class="btn-ghost" id="uiModeBtn">UI: Gro√ü (12.9)</button> 
      
      <div class="color-switcher">
        <button class="color-btn" data-theme="theme1" style="background: linear-gradient(45deg, #2f353b, #373f43);"></button>
        <button class="color-btn" data-theme="theme2" style="background: #f1f5f9;"></button>
        <button class="color-btn" data-theme="theme3" style="background: #141309;"></button>
        <button class="color-btn" data-theme="theme4" style="background: #222629;"></button>
        <button class="color-btn" data-theme="theme5" style="background: #fdfcf9;"></button>
        <button class="color-btn" data-theme="theme6" style="background: #f0fdf4;"></button>
      </div>
    </div>
  </div>
</header>

<main id="kasseView">
  <section class="products" aria-label="Produkte">
    <div class="products-header">
      <strong>Produkte</strong>
      <div style="display: flex; align-items: center; gap: 10px;">
        <div class="font-controls">
          <button class="btn-ghost" id="productFontDecreaseBtn" style="padding: 6px 8px; line-height: 1;">A--</button>
          <button class="btn-ghost" id="productFontIncreaseBtn" style="padding: 6px 8px; line-height: 1;">A++</button>
        </div>
        <div class="small">Tippe, um hinzuzuf√ºgen</div>
      </div>
    </div>
    <div class="grid" id="productsGrid"></div>
  </section>
  
  <div id="resizer"></div> 
  
  <aside class="order" aria-label="Kassenbereich" id="orderPanel">
    <button class="btn-danger" id="clearOrderBtn">Bestellung l√∂schen</button>
    <div class="order-header">
      <strong>Bestellung</strong>
      <div style="display: flex; align-items: center; gap: 10px;">
        <div class="font-controls">
          <button class="btn-ghost" id="orderFontDecrease" style="padding: 6px 8px; line-height: 1;">A-</button>
          <button class="btn-ghost" id="orderFontIncrease" style="padding: 6px 8px; line-height: 1;">A+</button>
        </div>
        <div class="small">Tippe Mengen manuell an</div>
      </div>
    </div>
    
    <div class="order-list" id="orderList" role="list" aria-live="polite"></div>
    
    <div class="summary">
      
      <div class="row summary-total-row">
        <div class="small">Gesamtsumme</div>
        <div class="big" id="totalDisplay">0,00 ‚Ç¨</div>
      </div>

      <div class="money-grid">
        <button class="money-btn" data-value="0.50">ü™ô 0,50 ‚Ç¨</button>
        <button class="money-btn" data-value="1">ü™ô 1 ‚Ç¨</button>
        <button class="money-btn" data-value="5">üí∂ 5 ‚Ç¨</button>
        <button class="money-btn" data-value="10">üí∂ 10 ‚Ç¨</button>
        <button class="money-btn" data-value="20">üí∂ 20 ‚Ç¨</button>
        <button class="money-btn" data-value="50">üí∂ 50 ‚Ç¨</button>
      </div>

      <div class="summary-input-row">
        <div class="input-group given-group">
          <label class="small" for="givenInput">Gegeben (‚Ç¨)</label>
          <input id="givenInput" type="number" step="0.5" min="0" inputmode="decimal" placeholder="0,00">
        </div>
        <div class="input-group change-group">
          <label class="small">‚Ü©Ô∏è R√ºckgeld</label>
          <div class="big" id="changeDisplay">0,00 ‚Ç¨</div>
        </div>
      </div>
      
      <div class="payment-buttons">
          <button class="btn-primary" id="saveOnlyBtn">üí∏ Nur Zahlung erfassen</button>
          <button class="btn-primary" id="saveAndPrintBtn">ü§ë Bon drucken</button>
      </div>
      
    </div>
    </aside>
</main>

<footer>
  <div>Speichert alle Vorg√§nge lokal im Browser (LocalStorage).
  Du kannst die Erfassungen als CSV herunterladen und auf deinem PC sichern.</div>
</footer>

<div id="logView" style="display:none;" aria-label="Erfassungen">
  <div class="log-receipt-view" role="dialog" aria-modal="true" aria-labelledby="logModalTitle">
    <div class="modal-header">
      <strong id="logModalTitle">Erfasste Zahlvorg√§nge</strong>
      <button class="btn-ghost" id="closeLogBtn">Zur√ºck zur Kasse</button>
    </div>
    <div id="logList"></div>
    <div class="modal-footer">
      <button class="btn-primary" id="downloadAllBtn">Alle als CSV herunterladen</button>
      <button class="btn-ghost" id="clearLogBtn">Log l√∂schen</button>
    </div>
  </div>
</div>

<div id="saveSuccessMessage" role="alert" aria-live="assertive">
</div>

</div> 
<script>
/* ===== Config & Data ===== */
const PRODUCTS=[
{id:'p1',emoji:'üçõ',name:'Chili con Carne',price:6.50},
{id:'p2',emoji:'üç≤',name:'K√§se Lauch Suppe',price:6.50},
{id:'p3',emoji:'üåØ',name:'Cheek√∂fte Wrap',price:4.50},
{id:'p4',emoji:'üçü',name:'Steakhouse Pommes',price:4.00},
{id:'p5',emoji:'ü•´',name:'Ketchup, Mayo, Sahne',price:0.50},
{id:'p6',emoji:'üç´',name:'Hei√üe Schokolade',price:3.50},
{id:'p7',emoji:'üçπ',name:'Bio Gl√ºhwein',price:4.00},
{id:'p8',emoji:'üí•',name:'Schuss Rum',price:1.00},
{id:'p9',emoji:'üå∂',name:'Hot Pottschatz',price:7.00},
{id:'p10',emoji:'üç≠',name:'Sweet Pottschatz',price:4.00}
];

const STORAGE_KEY='pottschatz_kasse_log_v1';
const THEME_STORAGE_KEY = 'pottschatz_kasse_theme_v1';
const PRODUCT_FONT_SIZE_KEY = 'pottschatz_kasse_font_product_v1';
const ORDER_FONT_SIZE_KEY = 'pottschatz_kasse_font_order_v1';
const KASSE_WIDTH_KEY = 'pottschatz_kasse_width_v1'; 
const GIVEN_KEY='pottschatz_kasse_given_v1';
const LAST_CSV_KEY='pottschatz_kasse_last_csv_v1';
const UI_MODE_KEY = 'pottschatz_ui_mode_v1'; 

let order={};
let lastExport = null;

/* ===== Helpers ===== */
const fmt=num=>num.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
function localSafe(fn, fallback=null){
¬† try { return fn(); } catch(e) { console.warn('LocalStorage/Operation failed:', e); return fallback; }
}

/* ===== UI Mode Toggle Logic (ROBUST) ===== */
const UI_MODE_DEFAULT = 'large'; 
const UI_MODE_COMPACT = 'compact'; 

function setUiMode(mode) {
    const htmlEl = document.documentElement;
    const btn = document.getElementById('uiModeBtn');
    
    htmlEl.classList.toggle('compact-ui', mode === UI_MODE_COMPACT);
    
    if (btn) { // Failsafe-Check f√ºr den Button
        if (mode === UI_MODE_COMPACT) {
            btn.textContent = 'UI: Kompakt (9.7)';
        } else {
            btn.textContent = 'UI: Gro√ü (12.9)';
        }
    }
    
    localSafe(() => localStorage.setItem(UI_MODE_KEY, mode));
}

function loadUiMode() {
    const savedMode = localSafe(() => localStorage.getItem(UI_MODE_KEY), UI_MODE_DEFAULT);
    setUiMode(savedMode);
}

function toggleUiMode() {
    const currentMode = document.documentElement.classList.contains('compact-ui') ? UI_MODE_COMPACT : UI_MODE_DEFAULT;
    const newMode = currentMode === UI_MODE_COMPACT ? UI_MODE_DEFAULT : UI_MODE_COMPACT;
    setUiMode(newMode);
}

/* ===== Resizer Logic (ROBUST) ===== */
function initResizer() {
    const resizer = document.getElementById('resizer');
    const orderPanel = document.getElementById('orderPanel');
    const kasseView = document.getElementById('kasseView');

    // Kritischer Failsafe-Check
    if (!resizer || !orderPanel || !kasseView) {
        return; 
    }
    
    const savedWidth = localSafe(() => localStorage.getItem(KASSE_WIDTH_KEY), null);
    if (savedWidth) {
        orderPanel.style.width = savedWidth;
    }
    
    let isResizing = false;
    let initialX;
    let initialWidth;

    const MIN_KASSE_WIDTH = 380; 
    const MAX_KASSE_WIDTH_PERCENT = 0.7; 

    const isHorizontal = () => window.getComputedStyle(kasseView).flexDirection !== 'column';

    resizer.addEventListener('mousedown', (e) => {
        if (!isHorizontal()) return;
        isResizing = true;
        initialX = e.clientX;
        initialWidth = orderPanel.offsetWidth;
        document.body.style.userSelect = 'none'; 
        document.body.style.cursor = 'col-resize';
    });
    
    resizer.addEventListener('touchstart', (e) => {
        if (!isHorizontal()) return;
        isResizing = true;
        initialX = e.touches[0].clientX;
        initialWidth = orderPanel.offsetWidth;
    });

    const handleMouseMove = (clientX) => {
        if (!isResizing) return;
        
        const deltaX = clientX - initialX;
        let newWidth = initialWidth - deltaX; 
        
        const maxKasseWidth = window.innerWidth * MAX_KASSE_WIDTH_PERCENT;
        newWidth = Math.max(MIN_KASSE_WIDTH, Math.min(newWidth, maxKasseWidth));

        orderPanel.style.width = `${newWidth}px`;
        localSafe(() => localStorage.setItem(KASSE_WIDTH_KEY, `${newWidth}px`));
    };

    document.addEventListener('mousemove', (e) => handleMouseMove(e.clientX));
    document.addEventListener('touchmove', (e) => {
        if (e.touches.length > 0) handleMouseMove(e.touches[0].clientX);
    }, { passive: false });

    const stopResizing = () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.userSelect = '';
            document.body.style.cursor = '';
        }
    };
    
    document.addEventListener('mouseup', stopResizing);
    document.addEventListener('touchend', stopResizing);
    document.addEventListener('touchcancel', stopResizing);
    
    window.addEventListener('resize', () => {
        // Erneuter Check, falls die Gr√∂√üe ge√§ndert wird, w√§hrend der Resizer nicht sichtbar ist
        if (!isHorizontal()) {
            orderPanel.style.width = '100%';
        } else {
            const currentWidth = orderPanel.style.width;
            const targetWidth = localSafe(() => localStorage.getItem(KASSE_WIDTH_KEY), '500px');
            if (currentWidth === '100%' || currentWidth === 'auto' || currentWidth === '') {
                orderPanel.style.width = targetWidth;
            }
        }
    });
}


/* ===== Font Size Functions (ROBUST) ===== */
let currentProductFontSizeStep = 0;
const FONT_STEP_EMOJI = 5; const FONT_BASE_EMOJI_PX = 45; 
const FONT_STEP_NAME = 2; const FONT_BASE_NAME_PX = 25; 

function setProductFontSize(step) {
  if (step < -2) step = -2; if (step > 3) step = 3; 
  currentProductFontSizeStep = step;
  localSafe(() => localStorage.setItem(PRODUCT_FONT_SIZE_KEY, step));
  
  // Diese Zeilen sind robust
  document.documentElement.style.setProperty('--pbtn-emoji-size', `${4.5 + step * 0.6}vmin`); 
  document.documentElement.style.setProperty('--pbtn-name-size', `${2.5 + step * 0.3}vmin`); 
  
  const newEmojiSizePx = FONT_BASE_EMOJI_PX + (step * FONT_STEP_EMOJI);
  const newNameSizePx = FONT_BASE_NAME_PX + (step * FONT_STEP_NAME);
  document.documentElement.style.setProperty('--pbtn-emoji-size-px', `${newEmojiSizePx}px`); 
  document.documentElement.style.setProperty('--pbtn-name-size-px', `${newNameSizePx}px`); 
}

function loadProductFontSize() {
  const step = parseInt(localSafe(() => localStorage.getItem(PRODUCT_FONT_SIZE_KEY) || '0', '0'));
  currentProductFontSizeStep = step; 
  setProductFontSize(step);
}

let currentOrderFontSizeStep = 0;
const FONT_STEP_ORDER = 1; const FONT_BASE_SM = 16; const FONT_BASE_MD = 20; const FONT_BASE_LG = 28; 

function setOrderFontSize(step) {
  if (step < -2) step = -2; if (step > 3) step = 3; 
  currentOrderFontSizeStep = step;
  localSafe(() => localStorage.setItem(ORDER_FONT_SIZE_KEY, step));
  const newSm = FONT_BASE_SM + (step * FONT_STEP_ORDER);
  const newMd = FONT_BASE_MD + (step * (FONT_STEP_ORDER + 0.5)); 
  const newLg = FONT_BASE_LG + (step * (FONT_STEP_ORDER + 1)); 
  // Diese Zeilen sind robust
  document.documentElement.style.setProperty('--order-font-sm', newSm + 'px');
  document.documentElement.style.setProperty('--order-font-md', newMd + 'px');
  document.documentElement.style.setProperty('--order-font-lg', newLg + 'px');
}

function loadOrderFontSize() {
  const step = parseInt(localSafe(() => localStorage.getItem(ORDER_FONT_SIZE_KEY) || '0', '0'));
  setOrderFontSize(step);
}

/* ===== Theme Functions (ROBUST) ===== */
function setTheme(themeName) {
¬† document.documentElement.setAttribute('data-theme', themeName);
¬† localSafe(() => localStorage.setItem(THEME_STORAGE_KEY, themeName));
¬† document.querySelectorAll('.color-btn').forEach(btn => {
¬† ¬† btn.classList.toggle('active', btn.dataset.theme === themeName);
¬† });
}
function loadTheme() {
¬† const preferredTheme = localSafe(() => localStorage.getItem(THEME_STORAGE_KEY), 'theme1') || 'theme1';
¬† setTheme(preferredTheme);
}

/* ===== Render Products & Order functions (Kernfunktionen) ===== */
function renderProducts(){
¬† const list=document.getElementById('orderList'); 
¬† const grid=document.getElementById('productsGrid'); 
  // Failsafe: Wenn productsGrid fehlt, soll die Funktion einfach abbrechen
  if (!grid) return;

  grid.innerHTML='';
¬† PRODUCTS.forEach(p=>{
¬† ¬† const btn=document.createElement('button'); btn.className='pbtn'; btn.dataset.id=p.id;
¬† ¬† btn.innerHTML=`<strong><span class="pbtn-emoji">${p.emoji}</span> <span class="pbtn-name">${p.name}</span></strong><span>${fmt(p.price)} ‚Ç¨</span>`;
¬† ¬† btn.addEventListener('click',()=>{
¬† ¬† ¬† addProduct(p.id,1);
¬† ¬† ¬† btn.classList.add('active');
¬† ¬† ¬† setTimeout(()=>btn.classList.remove('active'),200);
      if(list) list.scrollTop = list.scrollHeight; // Failsafe scroll
¬† ¬† });
¬† ¬† grid.appendChild(btn);
¬† });
}

function addProduct(id,qty){ order[id]=(order[id]||0)+qty; if(order[id]<0) order[id]=0; renderOrder(); }
function removeItem(id){ delete order[id]; renderOrder(); }
function calcTotal(){ return Object.keys(order).reduce((sum,id)=>sum+PRODUCTS.find(p=>p.id===id).price*order[id],0); }

function renderOrder(){
¬† const list=document.getElementById('orderList'); 
  const totalDisplay = document.getElementById('totalDisplay');

  // Failsafe-Check f√ºr Listenelemente
  if (!list || !totalDisplay) return; 

  list.innerHTML='';
¬† const ids=Object.keys(order);
¬† if(ids.length===0){ list.innerHTML=`<div class="small" style="font-size: var(--order-font-md)">W√§hle Produkte aus, um die Bestellung zu starten.</div>`; }
¬† ids.forEach(id=>{
¬† ¬† const p=PRODUCTS.find(x=>x.id===id);
¬† ¬† const div=document.createElement('div'); div.className='order-item';
    
¬† ¬† div.innerHTML=`<div class="item-left">
        <div style="flex-grow:1;"><strong>${p.emoji} ${p.name}</strong><div class="small"></div></div>
¬† ¬†     <div class="item-controls">
¬† ¬†         <div class="qty">${order[id]}</div>
            <button class="icon-btn" aria-label="remove-item" data-remove-id="${id}">üóë</button>
¬† ¬†         <button class="icon-btn" aria-label="minus" data-id="${id}">‚àí</button>
¬† ¬†         <button class="icon-btn" aria-label="plus" data-id="${id}">+</button>
¬† ¬†     </div>
    </div>
¬† ¬† <div style="text-align:right">
        <div>${fmt(p.price*order[id])} ‚Ç¨</div>
    </div>`;
    
¬† ¬† div.querySelector('button[aria-label="minus"]').addEventListener('click',()=>addProduct(id,-1));
¬† ¬† div.querySelector('button[aria-label="plus"]').addEventListener('click',()=>addProduct(id,1));
¬† ¬† div.querySelector('[data-remove-id]').addEventListener('click',()=>removeItem(id));
    
¬† ¬† list.appendChild(div);
¬† });
¬† totalDisplay.textContent=fmt(calcTotal())+' ‚Ç¨';
¬† updateChange();
}

/* =====================================================
--- JS: 'updateChange' ---
===================================================== */
function updateChange(){
¬† const givenInput = document.getElementById('givenInput');
  const changeDisplayEl = document.getElementById('changeDisplay');

  // Failsafe-Check
  if (!givenInput || !changeDisplayEl) return;
  
¬† let given = parseFloat(givenInput.value || 0);
¬† if(isNaN(given)) given = 0;
¬† localSafe(()=>localStorage.setItem(GIVEN_KEY, given.toString()));

  const total = calcTotal();
  const change = given - total; 
  
  changeDisplayEl.textContent = fmt(change) + ' ‚Ç¨';

  if (change < 0) {
    changeDisplayEl.classList.add('deficit');
  } else {
    changeDisplayEl.classList.remove('deficit');
  }
}

function loadGiven(){
¬† const v = localSafe(()=>localStorage.getItem(GIVEN_KEY), null);
¬† if(v !== null){
¬† ¬† const gi = document.getElementById('givenInput');
    if (gi) { // Failsafe-Check
¬† ¬† ¬† gi.value = parseFloat(v);
¬† ¬† ¬† updateChange();
    }
¬† }
}

/* ===== Log (LocalStorage) & Capture Sale (Unver√§ndert) ===== */
function loadLog(){ return localSafe(()=>JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'), []); }
function saveLog(entries){ localSafe(()=>localStorage.setItem(STORAGE_KEY,JSON.stringify(entries))); }
function nextOrderNumber(){ const log=loadLog(); return log.length===0?1:Math.max(...log.map(x=>x.orderNr||0))+1; }

function showSuccessMessage(entry, shouldPrint) {
    const msgEl = document.getElementById('saveSuccessMessage');
    if (!msgEl) return;
    
    let bonContent = '';
    
    if (shouldPrint) {
        // --- BON-INHALT GENERIEREN ---
        bonContent += '<div class="bon-header" style="font-size: 20pt; margin-bottom: 20px;">*** POTTSCHATZ BON ***</div>';
        bonContent += `<div class="bon-header" style="font-size: 16pt;">Bestellung #${entry.orderNr}</div>`;
        bonContent += `<div style="text-align: center; margin-bottom: 20px; font-size: 14pt;">${entry.date} ${entry.time}</div>`;
        bonContent += '<div class="bon-separator"></div>';

        entry.items.forEach(it => {
            const itemTotal = (it.price * it.qty).toFixed(2).replace('.', ',');
            bonContent += `<div class="bon-item-row" style="font-size: 14pt;"><span>${it.qty}x ${it.name}</span><span>${itemTotal} ‚Ç¨</span></div>`;
        });
        
        bonContent += '<div class="bon-separator"></div>';

        bonContent += `<div class="bon-item-row bon-total" style="font-size: 22pt;"><span>GESAMT:</span><span>${entry.total.toFixed(2).replace('.', ',')} ‚Ç¨</span></div>`;
        bonContent += `<div class="bon-item-row" style="font-size: 16pt;"><span>Gegeben:</span><span>${(entry.given||0).toFixed(2).replace('.', ',')} ‚Ç¨</span></div>`;
        
        const changeText = entry.change < 0 ? "Schulden:" : "R√ºckgeld:";
        bonContent += `<div class="bon-item-row" style="font-size: 16pt;"><span>${changeText}</span><span>${entry.change.toFixed(2).replace('.', ',')} ‚Ç¨</span></div>`;
        
        bonContent += '<div class="bon-separator"></div>';
        
        bonContent += '<div class="bon-footer" style="margin-top: 20px; font-size: 14pt;">Vielen Dank f√ºr Ihre Bestellung!</div>';

        msgEl.innerHTML = bonContent;
        
        // DRUCK AUSL√ñSEN (Direkt)
        window.print();
        
        // OVERLAY ANZEIGEN (Optional: falls Druck abgebrochen wird)
        msgEl.classList.add('show');
        setTimeout(() => {
            msgEl.classList.remove('show');
        }, 2500); 

    } else {
        // --- RAKETEN-MELDUNG GENERIEREN ---
        const totalFmt = entry.total.toFixed(2).replace('.', ',');
        msgEl.innerHTML = `
            <div style="font-size: 120px; margin-bottom: 20px;">üöÄ</div>
            <div style="font-size: 40px; margin-bottom: 10px; font-weight: 900;">Zahlung erfasst!</div>
            <div style="font-size: 30px; font-weight: 700;">#${entry.orderNr} / ${totalFmt} ‚Ç¨</div>
        `;
        
        // OVERLAY ANZEIGEN
        msgEl.classList.add('show');
        setTimeout(() => {
            msgEl.classList.remove('show');
        }, 1500); 
    }
}

function captureSale(shouldPrint){
  const printBtn = document.getElementById('saveAndPrintBtn');
  const saveBtn = document.getElementById('saveOnlyBtn');

  // Failsafe-Check f√ºr Buttons 
  if(!printBtn || !saveBtn) {
      console.error("Zahlungs-Buttons nicht gefunden.");
      return;
  }

  if(printBtn.disabled || saveBtn.disabled) return;
  printBtn.disabled = true;
  saveBtn.disabled = true;

  const total=calcTotal(); 
  if(total<=0){ 
    alert('Keine Produkte in der Bestellung.'); 
    printBtn.disabled=false;
    saveBtn.disabled=false;
    return; 
  }
  const givenInput = document.getElementById('givenInput');
  const given=parseFloat(givenInput ? givenInput.value : 0 || 0);
  const change = given - total; 

  if(change < 0 && !confirm('Gegeben < Summe (Defizit: '+fmt(change)+' ‚Ç¨). Trotzdem erfassen?')) { 
    printBtn.disabled=false;
    saveBtn.disabled=false;
    return; 
  }
  
  const now=new Date();
  const nextNr = nextOrderNumber();
  const entry={
    date:now.toLocaleDateString('de-DE'),
    time:now.toLocaleTimeString('de-DE'),
    orderNr:nextNr,
    items:Object.keys(order).map(id=>{ 
      const p=PRODUCTS.find(x=>x.id===id); 
      return {name: `${p.emoji} ${p.name}`, qty:order[id], price:p.price}; 
    }),
    total:total,
    given:given,
    change:change 
  };
  const log=loadLog(); log.push(entry); saveLog(log);
  
  // clear order & given
  order={}; 
  if (givenInput) givenInput.value=''; 
  localSafe(()=>localStorage.removeItem(GIVEN_KEY)); 
  renderOrder(); 
  
  showSuccessMessage(entry, shouldPrint);

  printBtn.disabled=false; 
  saveBtn.disabled=false;
}

/* ===== CSV Export (Unver√§ndert) ===== */
function downloadCsv(){
¬† const log = loadLog();
¬† if(!log || log.length === 0){ alert('Keine Erfassungen vorhanden.'); return; }
¬† let csv = 'Datum;Uhrzeit;Bestellnummer;Artikel;Menge;Einzelpreis;Gesamtsumme;Gegeben;R√ºckgeld\n';
¬† log.forEach(e=>{
¬† ¬† e.items.forEach(it=>{
¬† ¬† ¬† csv += `${e.date};${e.time};${e.orderNr};"${it.name}";${it.qty};${it.price.toFixed(2).replace('.',',')};${e.total.toFixed(2).replace('.',',')};${(e.given||0).toFixed(2).replace('.',',')};${e.change.toFixed(2).replace('.',',')}\n`;
¬† ¬† });
¬† });
¬† const filename = 'erfassungen_pottschatz.csv';
¬† try{
¬† ¬† localStorage.setItem(LAST_CSV_KEY, JSON.stringify({ csv, filename, ts: Date.now() }));
¬† }catch(e){
¬† ¬† console.warn('Konnte CSV nicht in localStorage sichern:', e);
¬† }
¬† const blob = new Blob(["\ufeff", csv], { type: 'text/csv;charset=utf-8;' });
¬† const url = URL.createObjectURL(blob);
¬† lastExport = { url, filename, ts: Date.now() }; 
¬† const a = document.createElement('a');
¬† a.href = url;
¬† a.download = filename;
¬† document.body.appendChild(a);
¬† a.click();
¬† a.remove();
¬† showStatus('CSV exportiert ‚Äî Datei im Downloads-Ordner.', 3000);
¬† setTimeout(()=>{ try{ URL.revokeObjectURL(url); lastExport = null; }catch(e){} }, 10000);
}

/* ===== Re-open last export (Unver√§ndert) */
function reopenLastExport(){
¬† if(lastExport && lastExport.url){
¬† ¬† window.open(lastExport.url, '_blank');
¬† ¬† return;
¬† }
¬† const rec = localSafe(()=>JSON.parse(localStorage.getItem(LAST_CSV_KEY)), null);
¬† if(rec && rec.csv){
¬† ¬† const blob = new Blob(["\ufeff", rec.csv], { type: 'text/csv;charset=utf-8;' });
¬† ¬† const url = URL.createObjectURL(blob);
¬† ¬† window.open(url, '_blank');
¬† ¬† setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch(e){} }, 10000);
¬† ¬† return;
¬† }
¬† showStatus('Keine exportierte CSV gefunden. Bitte Export CSV dr√ºcken.', 3000);
¬† alert('Keine exportierte CSV gefunden. Die Datei sollte im Download-Ordner deines Ger√§ts liegen.');
}

/* ===== Log View (modal) (Unver√§ndert) ===== */
function showLogModal(){
  const modal = document.getElementById('logView');
  const list = document.getElementById('logList');
  if (!modal || !list) return; // Failsafe-Check
  const log = loadLog(); list.innerHTML='';
  
  if(log.length===0){ 
    list.innerHTML='<div class="small">Keine Erfassungen vorhanden.</div>'; 
  } else {
    log.slice().reverse().forEach(e=>{ 
      const wrapper = document.createElement('div');
      wrapper.className = 'log-item'; 
      let html = `<div><strong>Bestellung #${e.orderNr}</strong> <span class="small" style="margin-left:8px">${e.date} ${e.time}</span></div>`;
      html += '<div style="margin-top:6px">';
      e.items.forEach(it => {
        html += `<div class="log-row"><div>${it.qty}√ó ${it.name}</div><div>${(it.price*it.qty).toFixed(2).replace('.',',')} ‚Ç¨</div></div>`;
      });
      html += `</div>`;
      html += `<hr style="border:none;border-top:1px dashed var(--divider-color);margin:8px 0">`;
      html += `<div class="log-row big"><div>Gesamt</div><div>${e.total.toFixed(2).replace('.',',')} ‚Ç¨</div></div>`;
      html += `<div class="log-row"><div class="small">Gegeben</div><div class="small">${(e.given||0).toFixed(2).replace('.',',')} ‚Ç¨</div></div>`;
      const changeText = e.change < 0 ? "Schulden:" : "R√ºckgeld:";
      html += `<div class="log-row"><div class="small">${changeText}</div><div class="small" style="${e.change < 0 ? 'color: var(--text-change-negative-color);' : ''}">${e.change.toFixed(2).replace('.',',')} ‚Ç¨</div></div>`;
      wrapper.innerHTML = html;
      list.appendChild(wrapper);
    });
  }
  
  // Failsafe-Zugriff auf kasseView
  const kasseView = document.getElementById('kasseView');
  if (kasseView) kasseView.style.display = 'none';
  
  modal.style.display = 'flex';
}

function hideLogModal(){
¬† const modal = document.getElementById('logView');
¬† if (!modal) return; // Failsafe-Check
¬† modal.style.display = 'none';
¬† 
  const kasseView = document.getElementById('kasseView');
  if (kasseView) kasseView.style.display = 'flex'; 
}

/* ===== Utility: show temporary status in header (Unver√§ndert) */
let statusTimer = null;
function showStatus(msg, ms = 2000){
¬† const el = document.getElementById('statusRegion');
  if (!el) return; // Failsafe-Check
¬† el.textContent = msg;
¬† if(statusTimer) clearTimeout(statusTimer);
¬† statusTimer = setTimeout(()=>{ el.textContent = 'AutoSave ‚Ä¢ Local CSV Export ‚Ä¢ Tool'; }, ms);
}

/* ===== Delete Log (Unver√§ndert) ===== */
function clearLog(){
¬† if(!confirm('!!! ACHTUNG !!!\n\nWirklich ALLE erfassten Zahlvorg√§nge unwiderruflich l√∂schen?')) return;
¬† saveLog([]);
¬† showStatus('Alle Erfassungen gel√∂scht.', 2500);
¬† showLogModal(); 
}


/* ===== Init & Events (ROBUST & KORRIGIERT) ===== */
document.addEventListener('DOMContentLoaded',()=>{
  
  localSafe(loadTheme);
  localSafe(loadProductFontSize); 
  localSafe(loadOrderFontSize); 
  localSafe(loadUiMode); 
  localSafe(initResizer); 
  
  // Kernfunktionen m√ºssen laufen
  renderProducts();¬†
  localSafe(loadGiven); 
¬† renderOrder();
¬†¬†
  // Event Listener: Wir pr√ºfen die Existenz von Elementen bevor wir Listener anh√§ngen
¬† const givenInput = document.getElementById('givenInput'); // <--- Hier deklariert
¬† if(givenInput) givenInput.addEventListener('input',updateChange);
  
¬† const clearOrderBtn = document.getElementById('clearOrderBtn');
¬† if(clearOrderBtn) clearOrderBtn.addEventListener('click',()=>{ 
    if(confirm('Bestellung wirklich l√∂schen?')){ 
      order={}; 
      renderOrder(); 
      if(givenInput) givenInput.value=''; 
      localSafe(()=>localStorage.removeItem(GIVEN_KEY)); 
    }
  });

  // EVENT LISTENER F√úR ZAHLUNG
¬† const saveAndPrintBtn = document.getElementById('saveAndPrintBtn');
¬† const saveOnlyBtn = document.getElementById('saveOnlyBtn');
¬† if(saveAndPrintBtn) saveAndPrintBtn.addEventListener('click',()=>captureSale(true)); 
¬† if(saveOnlyBtn) saveOnlyBtn.addEventListener('click',()=>captureSale(false));

  // EVENT LISTENER F√úR LOG / EXPORT
¬† const exportCsvBtn = document.getElementById('exportCsvBtn');
¬† const downloadAllBtn = document.getElementById('downloadAllBtn');
¬† const openExportFolderBtn = document.getElementById('openExportFolderBtn');
¬† const uiModeBtn = document.getElementById('uiModeBtn');
¬† const showLogBtn = document.getElementById('showLogBtn');
¬† const closeLogBtn = document.getElementById('closeLogBtn');
¬† const clearLogBtn = document.getElementById('clearLogBtn');
¬† const printBtn = document.getElementById('printBtn');
¬† const prodFontInc = document.getElementById('productFontIncreaseBtn');
¬† const prodFontDec = document.getElementById('productFontDecreaseBtn');
¬† const orderFontInc = document.getElementById('orderFontIncrease');
¬† const orderFontDec = document.getElementById('orderFontDecrease');

  if(exportCsvBtn) exportCsvBtn.addEventListener('click',downloadCsv);
  if(downloadAllBtn) downloadAllBtn.addEventListener('click',downloadCsv);
  if(openExportFolderBtn) openExportFolderBtn.addEventListener('click', reopenLastExport);
  if(uiModeBtn) uiModeBtn.addEventListener('click', toggleUiMode);
¬† if(showLogBtn) showLogBtn.addEventListener('click', showLogModal);
¬† if(closeLogBtn) closeLogBtn.addEventListener('click', hideLogModal);
¬† if(clearLogBtn) clearLogBtn.addEventListener('click', clearLog);
  if(printBtn) printBtn.addEventListener('click', ()=> { window.print(); });

  // EVENT LISTENER F√úR SCHRIFTGR√ñ√üEN
  if(prodFontInc) prodFontInc.addEventListener('click', () => { setProductFontSize(currentProductFontSizeStep + 1); });
  if(prodFontDec) prodFontDec.addEventListener('click', () => { setProductFontSize(currentProductFontSizeStep - 1); });
  if(orderFontInc) orderFontInc.addEventListener('click', () => { setOrderFontSize(currentOrderFontSizeStep + 1); });
  if(orderFontDec) orderFontDec.addEventListener('click', () => { setOrderFontSize(currentOrderFontSizeStep - 1); });


  // EVENT LISTENER F√úR GELDBUTTONS / THEMES
¬† document.querySelectorAll('.money-btn').forEach(btn=>{
¬† ¬† btn.addEventListener('click',()=>{
¬† ¬† ¬† const val=parseFloat(btn.dataset.value);
      // üî• FIX: 'givenInput' anstelle von 'input' verwenden
¬† ¬† ¬† if(givenInput) givenInput.value=(parseFloat(givenInput.value||0)+val).toFixed(2);
¬† ¬† ¬† updateChange();
¬† ¬† });
¬† });

¬† document.querySelectorAll('.color-btn').forEach(btn => {
¬† ¬† btn.addEventListener('click', () => {
¬† ¬† ¬† setTheme(btn.dataset.theme);
¬† ¬† });
¬† });

  // Status-Update
  const rec = localSafe(()=>JSON.parse(localStorage.getItem(LAST_CSV_KEY)), null);
¬† if(rec && rec.csv){
¬† ¬† showStatus('Letzter CSV-Export gefunden (kann erneut ge√∂ffnet werden).', 2000);
¬† }
});
</script>
</body>
</html>
